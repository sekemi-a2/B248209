---
title: "Assessment"
output: html_document
date: "2025-10-31"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### The impact of COVID-19 pandemic on Type 2 diabetes medication prescribing patterns, and how prescription patterns vary across deprived areas?

##### During the COVID-19 pandemic and its associated lockdowns, population health was significantly affected. Reduced physical activity, disruptions to daily routines, and increased comfort eating contributed to rising concerns about weight gain and metabolic health. Given these conditions, an increase in obesity and consequently Type 2 diabetes might be expected. This project examines how Type 2 diabetes prescribing patterns changed during the pandemic and whether these changes differed across socioeconomically deprived areas.


```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(janitor) # cleaning data
library(gt) # tables
library(here) # directory structure
library(readxl) # read in excel file
library(sf) #to read in map data

#Get data from 24-month period from Mar 2020 - Feb 2022 
#create function to read data in:
prescriptions_data <- function() {
  files <- c(paste0(c("mar", "apr", "may", "jun", "jul", "aug", "sep", "oct", "nov", "dec"), "2020"),
             paste0(c("jan", "feb", "mar", "apr", "may", "jun", "jul", "aug", "sep", "oct", "nov", "dec"), "2021"),
             paste0(c("jan", "feb"), "2022"))
  
  map_dfr(files, ~read_csv(here("data", paste0(.x, ".csv"))) %>%
                   clean_names() %>%
                   mutate(file_name = .x))}

# Read in data
data_for_years <- prescriptions_data()
deprivation_stats <- read_excel(here("data/SIMD.xlsx"))
```

```{r message=FALSE, warning=FALSE}
#Read in and tidy healthboard population database
population_data <- read_csv(here("data/general_health_census.csv"), skip = 10) %>% 
  filter(!is.na('All people')) %>%  #Removes NA
  rename(hb_name = "General health",
         hb_population = "All people") %>% 
  select(hb_name, hb_population) %>% 
  filter(!str_detect(hb_population, "Cells")) #Removes rows with text in population (to remove copyright info)
```


```{r message=FALSE, warning=FALSE}
diabetes_summary <- data_for_years %>%
  #filter for diabetes medications
  filter(!is.na(bnf_item_description)) %>% 
  filter(str_detect(bnf_item_description,
                    regex("metformin|gliptin|gliflozin|glutide|glitazone|gliclazide|glimepiride", ignore_case = TRUE))) %>% 
    group_by(paid_date_month, hbt) %>% 
    summarise(paid_quantity = sum(paid_quantity, na.rm = TRUE)) %>% 
#change months from numbers to letters
    mutate(paid_date_month = ym(paid_date_month),
         month_name = format(paid_date_month, "%B"),
         month_name = factor(month_name, 
                            levels = c("March", "April", "May", "June", "July", "August", "September", "October", "November", "December", "January", "February")))

# Merge all tables together
combined_health_data <- deprivation_stats %>%
  full_join(diabetes_summary, join_by(HBcode == hbt), relationship = "many-to-many") %>%
  left_join(population_data, join_by(HBname == hb_name))

# Now calculate prescriptions per person
combined_health_data <- combined_health_data %>%
  group_by(HBname, month_name) %>%
  mutate(quantity_per_head = sum(paid_quantity, na.rm = TRUE) / mean(as.numeric(hb_population))) #calculate prescriptions per person and change hb_population to numeric value instead of character
```



```{r message=FALSE, warning=FALSE}
# Creating a summary table and filtering for common type 2 medications
totalmeds_plot <- combined_health_data %>% 
  ggplot(aes(x = paid_date_month, y = quantity_per_head)) +
  geom_line(colour = "darkblue") + #line plot for trends
  labs(
    title = "Prescription of type 2 dabetes medications per person",
    subtitle = "March 2020 - February 2022",
    x = "Month",
    y = "Quantity per head"
  ) +
  theme_light() +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  facet_wrap(~HBname)

print(totalmeds_plot)
```

```{r message=FALSE, warning=FALSE}
# Collapse across Health Boards → compute national average per decile
simd_gradient <- combined_health_data %>%
  group_by(SIMD2020v2_Decile) %>%
  summarise(
    avg_qph = mean(quantity_per_head, na.rm = TRUE),
    .groups = "drop"
  )

# Plot
ggplot(simd_gradient, aes(x = SIMD2020v2_Decile, y = avg_qph)) +
  geom_point(size = 3) +
  geom_line() +
  geom_smooth(method = "lm", se = F, linetype = "dashed") + #line of best fit
  labs(
    title = "Average Diabetes Medications per Person by SIMD Decile",
    subtitle = "National average across all Health Boards, Mar 2020 – Feb 2022",
    x = "SIMD Decile (1 = Most Deprived)",
    y = "Avg. Medications per Person"
  ) +
  theme_minimal()

```

```{r}
# load the NHS Health board Shapefile
NHS_healthboards <- st_read(here("data/Week6_NHS_HealthBoards_2019.shp"))

#Join spatial data with other health data
combined_health_data <- NHS_healthboards %>%
  full_join(combined_health_data, by = join_by(HBCode == HBcode))
```


```{r message=FALSE, warning=FALSE}
# Combine values to gain average for each health board
hb_map_data <- combined_health_data %>%
  group_by(HBname) %>%
  summarise(avg_qph = mean(quantity_per_head, na.rm = TRUE), # average meds/person
            avg_simd = mean(SIMD2020v2_Decile, na.rm = TRUE)) #average SIMD
    
#Plot a map
ggplot(hb_map_data) +
  geom_sf(aes(fill = avg_qph), color = "white") +
  scale_fill_distiller(
    palette = "YlOrRd",
    direction = 1,
    name = "Average quantity per person"
  ) +
  facet_wrap(~ cut(avg_simd, breaks = 3, labels = c("High", "Medium", "Low"))) +
  labs(
    title = "Prescribing Burden by Area-Level SIMD",
    subtitle = "Grouped into 3 deprivation categories"
  ) +
    theme_grey() + # THEME ADDED MIGHT DELETE IF NOT DIFFERENT TO AUTOMATIC THEME
  theme(
    plot.title = element_text(face = "bold", size = 16), 
    plot.subtitle = element_text(size = 8)
  )  
```

